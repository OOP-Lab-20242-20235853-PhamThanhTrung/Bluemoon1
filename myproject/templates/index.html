{% extends 'base.html' %}
{% load static %}
{% block home-content %}

    <div class="page-wrapper">
        <div class="page-breadcrumb">
            <div class="row">
                <div class="col-7 align-self-center">
                    <h3 class="page-title text-truncate text-dark font-weight-medium mb-1">おはようございます、{{ username }}さん!</h3>
                    <div class="d-flex align-items-center">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb m-0 p-0">
                                <li class="breadcrumb-item"><a href="{% url 'home' %}">ホーム</a>
                                </li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-4 g-3">
                <div class="col">
                    <div class="card border-end">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div>
                                    <div class="d-inline-flex align-items-center">
                                        <h2 class="text-dark mb-1 font-weight-medium">{{ total_nhankhau }}</h2>
                                    </div>
                                    <h6 class="text-muted font-weight-normal mb-0 w-100 text-truncate">総居住者数
                                    </h6>
                                </div>
                                <div class="ms-auto mt-md-3 mt-lg-0">
                                    <span class="opacity-7 text-muted"><i data-feather="user-plus"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card border-end">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div>
                                    <div class="d-inline-flex align-items-center">
                                        <h2 class="text-dark mb-1 font-weight-medium">{{ total_hokhau }}</h2>
                                    </div>
                                    <h6 class="text-muted font-weight-normal mb-0 w-100 text-truncate">総世帯数
                                    </h6>
                                </div>
                                <div class="ms-auto mt-md-3 mt-lg-0">
                                    <span class="opacity-7 text-muted"><i data-feather="home"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card border-end ">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div>
                                    <div class="d-inline-flex align-items-center">
                                        <h2 class="text-dark mb-1 w-100 text-truncate font-weight-medium">{{ doanhthu_formatted }} VND</h2>
                                    </div>
                                    <h6 class="text-muted font-weight-normal mb-0 w-100 text-truncate">今月の売上
                                    </h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card border-end ">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div>
                                    <div class="d-inline-flex align-items-center">
                                        <h2 class="text-dark mb-1 font-weight-medium">{{ so_luong_tam_tru }}/{{ so_luong_tam_vang }}</h2>
                                    </div>
                                    <h6 class="text-muted font-weight-normal mb-0 w-100 text-truncate">
                                        一時滞在 / 不在
                                    </h6>
                                </div>
                                <div class="ms-auto mt-md-3 mt-lg-0">
                                    <span class="opacity-7 text-muted"><i data-feather="user-check"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-6 col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">収益内訳</h4>
                            <div id="campaign-v2" class="mt-2" style="height:283px; width:100%;"></div>
                            <ul class="list-style-none mb-0">
                                {% for stat in khoanthu_stats %}
                                <li{% if forloop.counter > 1 %} class="mt-3"{% endif %}>
                                    <i class="fas fa-circle {% if stat.khoanthu__tenkhoanthu == 'Khác' %}text-white{% else %}{% cycle 'text-primary' 'text-danger' 'text-cyan' %}{% endif %} font-10 me-2" {% if stat.khoanthu__tenkhoanthu == 'Khác' %}style="color: #edf2f6 !important;"{% endif %}></i>
                                    <span class="text-muted">{{ stat.khoanthu__tenkhoanthu }} ({{ stat.percentage|floatformat:1 }}%)</span>
                                    <span class="text-dark float-end font-weight-medium">{{ stat.total|floatformat:0 }} VND</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">月別売上推移</h4>
                            <div class="net-income mt-4 position-relative" style="height:294px;"></div>
                            <ul class="list-inline text-center mt-5 mb-2">
                                <li class="list-inline-item text-muted fst-italic">過去6ヶ月の売上 (百万VND)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // Cập nhật biểu đồ Net Income với dữ liệu thực từ database
    window.addEventListener('load', function() {
        setTimeout(function() {
            // Xóa biểu đồ cũ nếu có
            $('.net-income').empty();
            
            var chartLabels = {{ chart_labels|safe }};
            var chartSeries = {{ chart_series|safe }};
            
            var data = {
                labels: chartLabels,
                series: chartSeries
            };
            
            var options = {
                axisX: {
                    showGrid: false
                },
                axisY: {
                    labelInterpolationFnc: function(value) {
                        return value.toFixed(1) + 'M';
                    }
                },
                seriesBarDistance: 1,
                chartPadding: {
                    top: 15,
                    right: 15,
                    bottom: 5,
                    left: 0
                },
                plugins: [
                    Chartist.plugins.tooltip()
                ],
                width: '100%'
            };
            
            var responsiveOptions = [
                ['screen and (max-width: 640px)', {
                    seriesBarDistance: 5,
                    axisX: {
                        labelInterpolationFnc: function (value) {
                            return value[0];
                        }
                    }
                }]
            ];
            
            new Chartist.Bar('.net-income', data, options, responsiveOptions);
        }, 500);
    });

    // Biểu đồ Khoản Thu
    window.addEventListener('load', function() {
        setTimeout(function() {
            var khoanthuLabels = {{ khoanthu_labels|safe }};
            var khoanthuSeries = {{ khoanthu_series|safe }};
            
            if (khoanthuLabels.length > 0) {
                $('#campaign-v2').empty();
                
                var columns = khoanthuLabels.map((label, i) => [label, khoanthuSeries[i]]);
                
                var chart = c3.generate({
                    bindto: '#campaign-v2',
                    data: {
                        columns: columns,
                        type: 'donut',
                        tooltip: { show: true }
                    },
                    donut: {
                        label: { 
                            show: false
                        },
                        title: "内訳", // Uchuwake (Chi tiết)
                        width: 18
                    },
                    legend: { hide: true },
                    color: { pattern: ["#5f76e8", "#ff4f70", "#01caf1", "#edf2f6"] }
                });
                
                d3.select('#campaign-v2 .c3-chart-arcs-title').style('font-family', 'Rubik');
            }
        }, 1000);
    });
</script>

{% endblock home-content %}